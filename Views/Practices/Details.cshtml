@model Sofia.Web.Models.Practice
@{
    ViewData["Title"] = Model.Name;
}

<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">@GetCategoryEmoji(Model.Category) @Model.Name</h4>
                    <span class="badge bg-primary">‚è±Ô∏è @Model.DurationMinutes –º–∏–Ω</span>
                </div>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <span class="badge bg-secondary">@GetCategoryName(Model.Category)</span>
                </div>
                
                <p class="lead">@Model.Description</p>
                
                @if (!string.IsNullOrEmpty(Model.Instructions))
                {
                    <div class="alert alert-info">
                        <h6 class="alert-heading">üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</h6>
                        <p class="mb-0">@Model.Instructions</p>
                    </div>
                }
                
                <div class="row g-3 mt-4">
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6>‚è±Ô∏è –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</h6>
                                <h4 class="text-primary">@Model.DurationMinutes –º–∏–Ω</h4>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <h6>üìÇ –ö–∞—Ç–µ–≥–æ—Ä–∏—è</h6>
                                <h5>@GetCategoryEmoji(Model.Category) @GetCategoryName(Model.Category)</h5>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Timer Section -->
                <div class="mt-4">
                    <div class="card border-primary">
                        <div class="card-header bg-primary text-white text-center">
                            <h5 class="mb-0">‚è±Ô∏è –¢–∞–π–º–µ—Ä –ø—Ä–∞–∫—Ç–∏–∫–∏</h5>
                        </div>
                        <div class="card-body text-center">
                            <div class="timer-display mb-4">
                                <div class="timer-circle mx-auto">
                                    <div class="timer-text" id="timerDisplay">@Model.DurationMinutes:00</div>
                                    <div class="timer-label">–û—Å—Ç–∞–ª–æ—Å—å –≤—Ä–µ–º–µ–Ω–∏</div>
                                </div>
                            </div>
                            <div class="timer-controls d-flex justify-content-center gap-2 flex-wrap">
                                <button type="button" class="btn btn-success btn-lg" id="startBtn" onclick="startTimer()">
                                    ‚ñ∂Ô∏è –°—Ç–∞—Ä—Ç
                                </button>
                                <button type="button" class="btn btn-warning btn-lg" id="pauseBtn" onclick="pauseTimer()" disabled>
                                    ‚è∏Ô∏è –ü–∞—É–∑–∞
                                </button>
                                <button type="button" class="btn btn-danger btn-lg" id="stopBtn" onclick="stopTimer()" disabled>
                                    ‚èπÔ∏è –°—Ç–æ–ø
                                </button>
                                <button type="button" class="btn btn-secondary btn-lg" id="resetBtn" onclick="resetTimer()" disabled>
                                    üîÑ –°–±—Ä–æ—Å
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card-footer">
                <div class="d-flex justify-content-between">
                    <a href="/practices" class="btn btn-secondary">‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É</a>
                    <form method="post" action="/practices/start/@Model.Id" class="d-inline">
                        <button type="submit" class="btn btn-primary btn-lg">
                            ‚ñ∂Ô∏è –ù–∞—á–∞—Ç—å –ø—Ä–∞–∫—Ç–∏–∫—É
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Practice Tips -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">üí° –°–æ–≤–µ—Ç—ã –¥–ª—è –ø—Ä–∞–∫—Ç–∏–∫–∏</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2">‚úÖ –ù–∞–π–¥–∏—Ç–µ —Ç–∏—Ö–æ–µ –º–µ—Å—Ç–æ –±–µ–∑ –æ—Ç–≤–ª–µ—á–µ–Ω–∏–π</li>
                    <li class="mb-2">‚úÖ –£—Å—Ç—Ä–æ–π—Ç–µ—Å—å —É–¥–æ–±–Ω–æ, –Ω–æ –Ω–µ —Å–ª–∏—à–∫–æ–º —Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–Ω–æ</li>
                    <li class="mb-2">‚úÖ –û—Ç–∫–ª—é—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ</li>
                    <li class="mb-2">‚úÖ –ù–µ –∫—Ä–∏—Ç–∏–∫—É–π—Ç–µ —Å–µ–±—è, –µ—Å–ª–∏ –º—ã—Å–ª–∏ –±–ª—É–∂–¥–∞—é—Ç</li>
                    <li class="mb-0">‚úÖ –ó–∞–ø–∏—Å—ã–≤–∞–π—Ç–µ —Å–≤–æ–∏ –æ—â—É—â–µ–Ω–∏—è –ø–æ—Å–ª–µ –ø—Ä–∞–∫—Ç–∏–∫–∏</li>
                </ul>
            </div>
        </div>
    </div>
</div>

@functions {
    string GetCategoryEmoji(Sofia.Web.Models.PracticeCategory category)
    {
        return category switch
        {
            Sofia.Web.Models.PracticeCategory.Breathing => "ü´Å",
            Sofia.Web.Models.PracticeCategory.Visualization => "üåÖ",
            Sofia.Web.Models.PracticeCategory.CBT => "üß†",
            Sofia.Web.Models.PracticeCategory.Gestalt => "üé≠",
            Sofia.Web.Models.PracticeCategory.Meditation => "üßò",
            Sofia.Web.Models.PracticeCategory.Mindfulness => "üå±",
            Sofia.Web.Models.PracticeCategory.Relaxation => "üòå",
            _ => "üßò"
        };
    }
    
    string GetCategoryName(Sofia.Web.Models.PracticeCategory category)
    {
        return category switch
        {
            Sofia.Web.Models.PracticeCategory.Breathing => "–î—ã—Ö–∞–Ω–∏–µ",
            Sofia.Web.Models.PracticeCategory.Visualization => "–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è",
            Sofia.Web.Models.PracticeCategory.CBT => "–ö–ü–¢",
            Sofia.Web.Models.PracticeCategory.Gestalt => "–ì–µ—à—Ç–∞–ª—å—Ç",
            Sofia.Web.Models.PracticeCategory.Meditation => "–ú–µ–¥–∏—Ç–∞—Ü–∏—è",
            Sofia.Web.Models.PracticeCategory.Mindfulness => "–û—Å–æ–∑–Ω–∞–Ω–Ω–æ—Å—Ç—å",
            Sofia.Web.Models.PracticeCategory.Relaxation => "–†–µ–ª–∞–∫—Å–∞—Ü–∏—è",
            _ => category.ToString()
        };
    }
}

<style>
    .timer-display {
        padding: 20px 0;
    }
    
    .timer-circle {
        width: 200px;
        height: 200px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
        position: relative;
    }
    
    .timer-text {
        font-size: 3rem;
        font-weight: bold;
        color: white;
        font-family: 'Courier New', monospace;
        line-height: 1;
    }
    
    .timer-label {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.9);
        margin-top: 10px;
    }
    
    .timer-controls button {
        min-width: 120px;
    }
    
    .timer-controls button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    @@media (max-width: 768px) {
        .timer-circle {
            width: 150px;
            height: 150px;
        }
        
        .timer-text {
            font-size: 2rem;
        }
        
        .timer-controls {
            flex-direction: column;
        }
        
        .timer-controls button {
            width: 100%;
        }
    }
</style>

<script>
    let timerInterval = null;
    let totalSeconds = @Model.DurationMinutes * 60;
    let remainingSeconds = totalSeconds;
    let isRunning = false;
    let isPaused = false;
    
    function formatTime(seconds) {
        const mins = Math.floor(seconds / 60);
        const secs = seconds % 60;
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
    
    function updateDisplay() {
        document.getElementById('timerDisplay').textContent = formatTime(remainingSeconds);
        
        // –ò–∑–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç –ø—Ä–∏ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–∏ –∫ –∫–æ–Ω—Ü—É
        const timerCircle = document.querySelector('.timer-circle');
        if (remainingSeconds <= 60) {
            timerCircle.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
        } else if (remainingSeconds <= totalSeconds * 0.3) {
            timerCircle.style.background = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
        } else {
            timerCircle.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        }
    }
    
    function startTimer() {
        if (isPaused) {
            // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –ø–∞—É–∑—ã
            isPaused = false;
        } else {
            // –ù–∞—á–∏–Ω–∞–µ–º –∑–∞–Ω–æ–≤–æ
            remainingSeconds = totalSeconds;
        }
        
        isRunning = true;
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
        document.getElementById('startBtn').disabled = true;
        document.getElementById('pauseBtn').disabled = false;
        document.getElementById('stopBtn').disabled = false;
        document.getElementById('resetBtn').disabled = false;
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
        timerInterval = setInterval(function() {
            remainingSeconds--;
            updateDisplay();
            
            if (remainingSeconds <= 0) {
                stopTimer();
                // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
                showNotification('‚è∞ –í—Ä–µ–º—è –ø—Ä–∞–∫—Ç–∏–∫–∏ –∏—Å—Ç–µ–∫–ª–æ!', 'success');
                // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–≤—É–∫–æ–≤–æ–π —Å–∏–≥–Ω–∞–ª
                playCompletionSound();
            }
        }, 1000);
        
        updateDisplay();
    }
    
    function pauseTimer() {
        if (isRunning && !isPaused) {
            clearInterval(timerInterval);
            isPaused = true;
            isRunning = false;
            
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
        }
    }
    
    function stopTimer() {
        clearInterval(timerInterval);
        isRunning = false;
        isPaused = false;
        remainingSeconds = totalSeconds;
        updateDisplay();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
        document.getElementById('startBtn').disabled = false;
        document.getElementById('pauseBtn').disabled = true;
        document.getElementById('stopBtn').disabled = true;
        document.getElementById('resetBtn').disabled = false;
    }
    
    function resetTimer() {
        clearInterval(timerInterval);
        isRunning = false;
        isPaused = false;
        remainingSeconds = totalSeconds;
        updateDisplay();
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏
        document.getElementById('startBtn').disabled = false;
        document.getElementById('pauseBtn').disabled = true;
        document.getElementById('stopBtn').disabled = true;
        document.getElementById('resetBtn').disabled = true;
    }
    
    function showNotification(message, type) {
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        toast.textContent = message;
        
        const colors = {
            success: '#10b981',
            error: '#ef4444',
            info: '#3b82f6',
            warning: '#f59e0b'
        };
        
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${colors[type] || colors.info};
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            z-index: 10000;
            font-size: 1.1rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            animation: slideIn 0.3s ease;
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }
    
    function playCompletionSound() {
        // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π –∑–≤—É–∫–æ–≤–æ–π —Å–∏–≥–Ω–∞–ª
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
    }
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    document.addEventListener('DOMContentLoaded', function() {
        updateDisplay();
    });
    
    // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ —É—Ö–æ–¥–µ —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.addEventListener('beforeunload', function() {
        if (timerInterval) {
            clearInterval(timerInterval);
        }
    });
</script>
